// prisma/schema.full.prisma
// Consolidated Prisma schema created 2025-11-10

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * =========================
 * Enums
 * =========================
 */
enum Role {
  CLIENT
  PROVIDER
  ADMIN
}

enum OAuth {
  GOOGLE
  FACEBOOK
  APPLE
}

enum SectorType {
  PUBLIC
  PRIVATE
  NGO
  EDUCATION
  HEALTH
  OTHER
}

enum ServiceStatus {
  DRAFT
  PUBLISHED
  PAUSED
  ARCHIVED
}

enum ReportTargetType {
  USER
  SERVICE
  BOOKING
  OTHER
}

enum ReportStatus {
  PENDING
  RESOLVED
  REJECTED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

/**
 * =========================
 * Usuarios y Proveedores
 * =========================
 */
model User {
  id    String @id @default(cuid())
  name  String
  email String @unique

  password     String?
  passwordHash String?

  role Role @default(CLIENT)

  avatarKey      String?
  avatarUrl      String?
  avatarThumbUrl String?

  tokenVersion Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones existentes
  passwordResets PasswordReset[]
  providers      Provider[]
  reviews        Review[]
  services       Service[]       @relation("ProviderServices")
  favorites      Favorite[]      @relation("UserFavorites")

  reportsMade      Report[]  @relation("reportsMade")
  reportsHandled   Report[]  @relation("reportsHandled")
  clientBookings   Booking[] @relation("clientBookings")
  providerBookings Booking[] @relation("providerBookings")
  paymentsMade     Payment[] @relation("paymentsMade")
  paymentsReceived Payment[] @relation("paymentsReceived")

  // ✅ Relaciones de Chat
  clientConversations   Conversation[] @relation("ClientConversations")
  providerConversations Conversation[] @relation("ProviderConversations")
  sentMessages          Message[]      @relation("SentMessages")

  blocked Boolean @default(false)

  @@index([role])
}

model Provider {
  id        String   @id @default(cuid())
  userId    String
  type      OAuth
  oauthId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([type, oauthId])
  @@index([userId])
}

/**
 * =========================
 * Catálogo / Jerarquía
 * =========================
 */
model Category {
  id            String     @id @default(cuid())
  name          String
  imageUrl      String?
  imageThumbUrl String?
  isActive      Boolean    @default(true)
  sector        SectorType @default(OTHER)
  parentId      String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  parent       Category?     @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children     Category[]    @relation("CategoryHierarchy")
  services     Service[]
  serviceTypes ServiceType[] @relation("CategoryOnServiceType")
  promotions   Promotion[]   @relation("CategoryPromotions")

  @@unique([name, parentId])
  @@index([parentId])
  @@index([isActive])
  @@index([sector])
}

model ServiceType {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  imageUrl    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  categoryId  String?

  services Service[]
  category Category? @relation("CategoryOnServiceType", fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([categoryId])
  @@index([isActive])
}

/**
 * =========================
 * Servicios e Imágenes
 * =========================
 */
model ServiceImage {
  id        String   @id @default(cuid())
  serviceId String
  url       String
  thumbUrl  String?
  createdAt DateTime @default(now())

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
}

model Service {
  id           String   @id @default(cuid())
  title        String
  description  String
  priceFrom    Int?
  city         String?
  providerId   String?
  categoryId   String?
  ratingAvg    Float    @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  adminCreated Boolean  @default(false)

  coverUrl      String?
  coverThumbUrl String?

  serviceTypeId String?

  status    ServiceStatus @default(PUBLISHED)
  deletedAt DateTime?

  reviews     Review[]
  category    Category?      @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  provider    User?          @relation("ProviderServices", fields: [providerId], references: [id], onDelete: SetNull)
  serviceType ServiceType?   @relation(fields: [serviceTypeId], references: [id], onDelete: SetNull)
  images      ServiceImage[]
  favorites   Favorite[]     @relation("ServiceFavorites")
  promotions  Promotion[]
  bookings    Booking[]

  // ✅ Relación de Chat
  conversations Conversation[]

  @@unique([title, providerId], name: "service_title_provider_unique")
  @@index([categoryId])
  @@index([providerId])
  @@index([serviceTypeId])
  @@index([adminCreated])
  @@index([ratingAvg])
  @@index([createdAt])
  @@index([city, categoryId])
  @@index([serviceTypeId, city])
  @@index([status, deletedAt])
}

/**
 * =========================
 * Promociones
 * =========================
 */
model Promotion {
  id         String    @id @default(cuid())
  title      String?
  imageKey   String
  linkUrl    String?
  serviceId  String?
  categoryId String?
  isActive   Boolean   @default(true)
  startsAt   DateTime?
  endsAt     DateTime?
  order      Int       @default(0)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  service  Service?  @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  category Category? @relation("CategoryPromotions", fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([isActive, startsAt, endsAt])
  @@index([order, createdAt])
  @@index([categoryId])
  @@index([serviceId])
}

/**
 * =========================
 * Reseñas
 * =========================
 */
model Review {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  userId    String
  serviceId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, serviceId])
  @@index([serviceId])
  @@index([userId])
  @@index([createdAt])
}

/**
 * =========================
 * Reset de contraseña
 * =========================
 */
model PasswordReset {
  id        String    @id @default(cuid())
  userId    String
  tokenHash String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, expiresAt])
  @@index([expiresAt])
  @@index([userId, usedAt])
  @@map("password_resets")
}

/**
 * =========================
 * Favoritos
 * =========================
 */
model Favorite {
  id        String   @id @default(cuid())
  userId    String
  serviceId String
  createdAt DateTime @default(now())

  user    User    @relation("UserFavorites", fields: [userId], references: [id], onDelete: Cascade)
  service Service @relation("ServiceFavorites", fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([userId, serviceId])
  @@index([userId])
  @@index([serviceId])
}

/**
 * =========================
 * Admin (reportes, reservas, pagos)
 * =========================
 */
model Report {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reporter   User?   @relation("reportsMade", fields: [reporterId], references: [id])
  reporterId String?

  targetType  ReportTargetType
  targetId    String
  status      ReportStatus     @default(PENDING)
  reason      String?
  description String?

  handledBy   User?   @relation("reportsHandled", fields: [handledById], references: [id])
  handledById String?
}

model Booking {
  id         String        @id @default(cuid())
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  client     User          @relation("clientBookings", fields: [clientId], references: [id])
  clientId   String
  provider   User          @relation("providerBookings", fields: [providerId], references: [id])
  providerId String
  service    Service       @relation(fields: [serviceId], references: [id])
  serviceId  String
  startAt    DateTime?
  endAt      DateTime?
  amount     Decimal       @db.Decimal(10, 2)
  currency   String        @default("USD")
  status     BookingStatus @default(PENDING)
  payments   Payment[]     @relation("bookingPayments")
}

model Payment {
  id        String        @id @default(cuid())
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  amount    Decimal       @db.Decimal(10, 2)
  currency  String        @default("USD")
  method    String?
  status    PaymentStatus @default(PENDING)

  user       User?    @relation("paymentsMade", fields: [userId], references: [id])
  userId     String?
  provider   User?    @relation("paymentsReceived", fields: [providerId], references: [id])
  providerId String?
  booking    Booking? @relation("bookingPayments", fields: [bookingId], references: [id])
  bookingId  String?
}

/**
 * =========================
 * Chat & Mensajería
 * =========================
 */

/// Conversación entre dos usuarios (cliente-proveedor)
model Conversation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Participantes
  clientId   String
  providerId String

  // Relación con el servicio (opcional, para contexto)
  serviceId String?
  service   Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)

  // Último mensaje para ordenar conversaciones
  lastMessageAt   DateTime?
  lastMessageText String?

  // Mensajes de esta conversación
  messages Message[]

  // Usuarios participantes
  client   User @relation("ClientConversations", fields: [clientId], references: [id], onDelete: Cascade)
  provider User @relation("ProviderConversations", fields: [providerId], references: [id], onDelete: Cascade)

  // Una conversación única por par cliente-proveedor
  @@unique([clientId, providerId])
  @@index([clientId])
  @@index([providerId])
  @@index([serviceId])
  @@index([lastMessageAt])
}

/// Mensajes individuales en una conversación
model Message {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  // Remitente
  senderId String
  sender   User   @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  // Contenido
  type    MessageType @default(TEXT)
  content String      @db.Text

  // Metadata para archivos/imágenes
  mediaUrl String?

  // Estado de lectura
  readAt DateTime?

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@index([readAt])
}
